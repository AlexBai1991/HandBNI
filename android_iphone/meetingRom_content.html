<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/project/ui-res-v3.css">
    <link rel="stylesheet" href="css/project/ui-btn-v3.css">
    <link rel="stylesheet" href="css/project/ui-on-v3.css">
    <link rel="stylesheet" href="css/project/ui-color-v3.css">
    <link rel="stylesheet" href="css/ui-input.css">
        <link rel="stylesheet" href="css/ui-btn.css">
        <link rel="stylesheet" href="css/ui-img.css">
        <link rel="stylesheet" href="css/ui-res.css">
        <link rel="stylesheet" href="css/ui-list.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-color.css">
		<link rel="stylesheet" href="css/project/style.css">
        <script src="js/zy_control.js">
        </script>
        <script src="js/zy_click.js">
        </script>
        <script src="js/zy_json.js">
        </script>
        <script src="js/zy_tmpl.js">
        </script>
        <script src="js/main.js">
        </script>
    </head>
    <body class="um-vp" ontouchstart>

        <!--块容器开始-->
        <div class="ub ub-ver tx-c" style="width:98%;margin:0 auto;">
            <h1 id="date" class="ut ub-f1 tx-c t-bla uinn1"></h1>
            <!--会议室记录表头开始-->
            <div class="ub ubt ubl ubr b-gra uc-t1 ub-ver c-siv c-m1">
                <div class="ub t-bla">
                    <div class="ub-f1 ubr b-gra ub ub-ver">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div class="ub-con ut-s">
                                开始时间
                            </div>
                        </div>
                    </div>
                    <div class="ub-f1 ubr b-gra  ub ub-ver">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div class="ub-con ut-s">
                                结束时间
                            </div>
                        </div>
                    </div>
                    <div class="ub-f1 ubr b-gra  ub ub-ver">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div class="ub-con ut-s">
                                研究室
                            </div>
                        </div>
                    </div>
                    <div class="ub-f1 ub ub-ver">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div class="ub-con ut-s">
                                类别
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--会议室记录表头结束-->
            <!--会议室记录主表开始-->
            <div id="booklist" class="ub ub-ver uba b-gra uc-b1 c-wh">
            </div>
            <!--会议室记录主表结束-->
            <div class="ub ub-ver ubt1 ubl1 ubr1 ubb b-gra uc-t1 t-bla umar-t c-wh">
                <div class="ub uinn">
                    <div class="ub-f1 ub ub-ver">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div class="ub-con ut-s t-bla">
                                开始时间:
                            </div>
                        </div>
                    </div>
                    <div class="ub-f1 ub ub-ver  uc-a">
                        <div class="tx-c umh3 umar-b umar-t">
                            <div id="startTime" class="ub-con ut-s t-bla ulev-1">
                                请点击设置
                            </div>
                        </div>
                    </div>
                    <div ontouchstart="zy_touch('btn-act')" onclick="selectTime('start')" class="btn c-blu uinl uc-a ub t-wh ub-ac uinn">
                        <div class="ub-f1 ut-s">
                            <!--按钮开始-->
							<div class="btn uc-a bt-icon27 umh1-7 umw1-7 ub-img4"></div>
							<!--按钮结束-->
                        </div>
                    </div>
                </div>
            </div>
            <div class="ub ubb ubl1 ubr1 b-gra uinn c-wh">
                <div class="ub-f1 ub ub-ver">
                    <div class="tx-c umh3 umar-b umar-t">
                        <div class="ub-con ut-s t-bla">
                            结束时间:
                        </div>
                    </div>
                </div>
                <div class="ub-f1 ub ub-ver  uc-a">
                    <div class="tx-c umh3 umar-b umar-t">
                        <div id="endTime" class="ub-con ut-s t-bla ulev-1">
                            请点击设置
                        </div>
                    </div>
                </div>
                <div ontouchstart="zy_touch('btn-act')" onclick="selectTime('end')" class="btn c-blu uinl uc-a ub t-wh uinn ub-ac">
                    <div class="ub-f1 ut-s">
                        <!--按钮开始-->
						<div class="btn uc-a bt-icon27 umh1-7 umw1-7 ub-img4"></div>
						<!--按钮结束-->
                    </div>
                </div>
            </div>
            <!--下拉列表开始-->
            <div class="ub ubb1 ubl1 ubr1 b-gra uc-b1 t-bla uinn c-wh">                
				<div class="ub-f1 ub ub-ver">
                    <div class="tx-c umh3 umar-b umar-t">
                        <div class="ub-con t-bla">　研究室:</div>
                    </div>
                </div>

                <div class="ub-f1 ub uba1 uc-a1 c-wh b-gra sel">
                    <div id="selectedgroup" class="ub-f1 ut-s uinn ulev-1 tx-l">请选择研究室</div>
                    <div class="ubl b-gra c-blu umw2 ub ub-pc uc-r1 ub-ac">
                        <div class="ub-img umw1 umh1 res3">
                        </div>
                    </div>
                    <select name="sel0" selectedindex="0" id="sel0" onchange="zy_selectmenu(this.id)">
                        <option>田</option>
                        <option>孙</option>
                        <option>乔</option>
                        <option>李</option>
                        <option>王</option>
                        <option>黄</option>
                        <option>顾</option>
                   </select>
                </div>
            </div>
            <!--下拉列表结束-->
		</div>
        <!--预定按钮-->
        <div class="ub">
            <div class="ub-f1 uinn">
                <div ontouchstart="zy_touch('btn-act')" id="submitOrder" onclick="order()" class="btn uinn c-org uc-a t-wh">
                    预　订
                </div>
            </div>
            <div class="ub-f1 uinn">
                <div ontouchstart="zy_touch('btn-act')" onclick="cancle()" class="btn uinn c-org uc-a t-wh">
                    退　订
                </div>
            </div>
        </div>
    </body>
    <script>
        zy_init();
        var now = new Date();
        
        //存放所选日期的会议预订记录
        var orderlist;
        
        //存放所选日期的date变量
        var date = {
            year: now.getFullYear(),
            month: now.getMonth() + 1,
            day: now.getDate(),
        };
        
        //存放所选的预订开始时间
        var startTime = {
            hour: now.getHours(),
            minute: now.getMinutes(),
        };
        
        //存放所选的预订结束时间
        var endTime = {
            hour: now.getHours(),
            minute: now.getMinutes(),
        };
        
        window.uexOnload = function(type){
            if (!type) {
                $$("date").innerText = date.year + '-' + date.month + '-' + date.day;
                //获取当日会议室预订记录语句
                setHtml('booklist', "");
                getMeetingRomData(date);
            }
        }
        function openBookPage(){
            uexWindow.open("book", 0, "book.html", 10, "", "", 0);
        };
        
        //选择查看的会议室日期并获取当日会议室预订记录
        function selectDate(){
            uexControl.cbOpenDatePicker = function(opCode, dataType, data){
                if (dataType == 1) {
                    var obj = eval('(' + data + ')');
                    date.year = obj.year;
                    date.month = obj.month;
                    date.day = obj.day;
                    $$('date').innerText = date.year + '-' + date.month + '-' + date.day;
                    setHtml('startTime', '');
                    setHtml('endTime', '');
                    getMeetingRomData(date);
                }
            }
            uexControl.openDatePicker(date.year, date.month, date.day);
        };
        
        function getMeetingRomData(date){
            //按照日期向服务器端请求数据组织成条目
            setHtml('booklist', "");
            var url = "http://10.108.90.35:8080/zendproject/TestProject/bni/ReturnRoomOrder.php?date=" + date.year + '-' + date.month + '-' + date.day + "&action=getOrderInfo";
            var templ = '<div class="ub ubb b-gra t-bla">\
                                <div class="ub-f1 ub ubr b-gra  ub-ver">\
                                    <div class="tx-c umh3 umar-b umar-t">\
                                        <div class="ub-con ut-s">${starttime}</div>\
                                    </div>\
                                </div>\
                                <div class="ub-f1 ub ubr b-gra  ub-ver">\
                                    <div class="tx-c umh3 umar-b umar-t">\
                                        <div class="ub-con ut-s">${endtime}</div>\
                                    </div>\
                                </div>\
                                <div class="ub-f1 ub ubr b-gra  ub-ver">\
                                    <div class="tx-c umh3 umar-b umar-t">\
                                        <div class="ub-con ut-s">${ordergroup}</div>\
                                    </div>\
                                </div>\
                                <div class="ub-f1 ub ub-ver">\
                                    <div class="tx-c umh3 umar-b umar-t">\
                                        <div class="ub-con ut-s">${ordertype}</div>\
                                    </div>\
                                </div>\
                            </div>';
            $.getJSON(url, function(data){
                orderlist = data;
                var str = zy_tmpl(templ, orderlist, zy_tmpl_count(orderlist));
                setHtml('booklist', str);
            }, 'json', null, 'GET', null, false);
        };
        
        function selectTime(type){
            if (type == 'start') {
                uexControl.cbOpenTimePicker = function(opCode, dataType, data){
                    if (dataType == 1) {
                        var obj = eval('(' + data + ')');
                        startTime.hour = obj.hour;
                        startTime.minute = obj.minute;
                        $$('startTime').innerText = startTime.hour + ':' + startTime.minute;
                    }
                }
                uexControl.openTimePicker(int(startTime.hour), int(startTime.minute));
            }else {
                uexControl.cbOpenTimePicker = function(opCode, dataType, data){
                    if (dataType == 1) {
                        var obj = eval('(' + data + ')');
                        endTime.hour = obj.hour;
                        endTime.minute = obj.minute;
                        $$('endTime').innerText = endTime.hour + ':' + endTime.minute;
                    }
                }
                uexControl.openTimePicker(int(endTime.hour), int(endTime.minute));
            }
        };
        
        //时间比较函数
        function compareTime(selectTime, listTime){
            var hour1 = int(selectTime.hour);
            var hour2 = int(listTime.split(":")[0]);
            var minute1 = int(selectTime.minute);
            var minute2 = int(listTime.split(":")[1]);
            if (hour1 < hour2 || (hour1 == hour2 && minute1 < minute2)) {
                return -1;
            }else 
                if (hour1 == hour2 && minute1 == minute2) {
                    return 0;
                }else {
                    return 1;
                }
        };
        
        //确认预订时间不能与已预订时间冲突
        function checkTime(startTime, endTime){
            for (var i = 0, lenght = orderlist.length; i < lenght; i++) {
                if (compareTime(startTime, orderlist[i].starttime) > 0 && compareTime(startTime, orderlist[i].endtime) < 0) {
                    return false;//开始时间在其中一个时间段内
                }else 
                    if (compareTime(endTime, orderlist[i].starttime) > 0 && compareTime(endTime, orderlist[i].endtime) < 0) {
                        return false;//结束时间在其中一个时间段内
                    }
            }
            return true;//开始时间和结束时间都不在orderlist时间段内
        };
        
        //提交预订请求
        function order(){
            if ($$("startTime").innerText == "请点击设置" || $$("endTime").innerText == "请点击设置") {
                alert("请设置预订起止时间后再提交!")
            }else 
                if (endTime.hour < startTime.hour || (endTime.hour == startTime.hour && endTime.minute <= startTime.minute)) {
                    //提交到服务端
                    alert("结束时间不能早于或等于开始时间，请重新设置");
                }
                else 
                    if (!checkTime(startTime, endTime)) {
                        alert("您预订的时间段与已有预订有冲突，请重新设置");
                    }
                    else {
                        var group = document.getElementById('selectedgroup').innerHTML;
						var selectGroup = '';
						if (group == '请选择研究室'){
							alert('请选择研究室!');
						}else{
							selectGroup = encodeURI(group);
							var url = "http://10.108.90.35:8080/zendproject/TestProject/bni/ReturnRoomOrder.php?date=" + $$('date').innerText + "&starttime=" + $$('startTime').innerText + "&endtime=" + $$('endTime').innerText + "&group=" + selectGroup + "&action=orderRoom";
							$.getJSON(url, function(data){
								var result = data;
								if (result.orderInfo == "会议室预定成功!") {
									alert("预订成功!")
									$$('startTime').innerHTML = '请点击设置';
									$$('endTime').innerHTML = '请点击设置';
									$$('selectedgroup').innerHTML = '请选择研究室';
									getMeetingRomData(date);
								}else {
									alert("预订失败，请尝试刷新后重新提交!")
								}
							}, 'json', null, 'GET', null, false);
						}
                    }
        }
    </script>
</html>
