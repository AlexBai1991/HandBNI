<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/project/ui-res-v3.css">
    <link rel="stylesheet" href="css/project/ui-color-v3.css">
    <link rel="stylesheet" href="css/project/ui-btn-v3.css">
    	<link rel="stylesheet" href="css/ui-btn.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-box.css">
  	    <link rel="stylesheet" href="css/ui-input.css">
        <link rel="stylesheet" href="css/ui-color.css">
		<link rel="stylesheet" href="css/ui-res.css">
		<link rel="stylesheet" href="css/ui-list.css">
		<link rel="stylesheet" href="css/ui-img.css">
		<link rel="stylesheet" href="app/css/ui-scm.css">
		<link rel="stylesheet" href="css/project/style.css">
        <script src="js/zy_control.js"></script>
        <script src="js/zy_click.js"></script>
        <script src="js/zy_json.js"></script>
        <script src="js/main.js"></script>
        <script>
        </script>
    </head>
    <body class="um-vp" style="background-color:#e9eaee;" ontouchstart>
        <div id="page_0" class="up ub ub-ver" tabindex="0">
            <!--header开始-->
            <div id="header" class="uh ub c-blu t-wh">
	            <!--按钮开始-->
				<div onclick="winClose('-1')" class="btn umw2 uinn uc-a bt-icon12 umh1-7 umw1-7 ub-img4"></div>
				<!--按钮结束-->
                <h1 class="ub-f1 ut ulev0 ut-s tx-c" tabindex="0">个人中心</h1>
				<div class="umw2"></div>
            </div>
            <!--header结束--><!--content开始-->
            <div id="content" class="ub-f1 tx-l t-bla">
                <div id="userinfo" class="" style="display:block;">
                	<br>
					<div class="b-gra uc-n">    	 
				 		<div class="uc-n ub b-gra t-bla ub-ac lis">	 
				     		<div class="lis-th2 ub-img5 uc-a1" ontouchstart="zy_touch('')"  onclick="openActionSheet();">
				     			<img src="image/headpic.gif" class="inforpic" id="headpic"/>
								<div class="inforpos" id="tpic">
									<img src="image/pic.png" class="inforimg"/>
								</div>
				     		</div>     	 
				 			<div class="ub-f1 ub ub-ver">	 
				 	    		<div class="ulev1 ut-s ulev0" id="username">&nbsp;</div>		    
				    			<div class="t-gra ut-s ulev-1  umar-t" id="motto">&nbsp;</div>	 
				 	   		 	<div class="t-gra ut-s ulev-1  umar-t"><span id="sex">保密　</span><span id="grade">&nbsp;</span><span id="place">&nbsp;</span></div>	 
				 			</div>
							<div class="umar-l">
								<div class="t-gra ut-s ulev-1" id="gtitle">&nbsp;</div>
								<span id="isfd">
									<span class="ub-img5 inforbtn" ontouchstart="zy_touch('inforbtn1')" onclick="logOutCf();"></span>	
								</span>
							</div>      
				 		</div>  
				  	</div>
					<!--注释
                    <ul ontouchstart="zy_touch('btn-act')" class="umh5 uba b-gra uc-a1 c-wh ub t-bla ub-ac lis" style="width:90%;margin:2px auto;">
                        <li id="headPic" onclick="openActionSheet()" class="lis-icon ub-img im3">
                        </li>
                        <li id="username" class="ub-f1 ut-s">
                            
                        </li>
                        <li class="res8 lis-sw ub-img">
                        </li>
                    </ul>
					-->
                    <br>
                    <ul ontouchstart="zy_touch('btn-act')" class="umh4 ub uba b-gra uc-a1 c-wh t-bla ub-ac lis" style="width:90%;margin:0 auto;">
                        <li id="usergroup" class="ub-f1 ut-s">
                          
                        </li>
                    </ul>
					<br>
                    <ul ontouchstart="zy_touch('btn-act')" onclick="displayChangePass()" class="umh2 ub uba b-gra uc-a c-m2 t-bla ub-ac lis c-red1 ulev-1" style="width:95%;margin:0 auto;">
                        <li class="ub-f1 ulev-1 tx-c ut-s">
                            修改密码
                        </li>
                    </ul>
                </div>
				
				<div id="userchangepass" style="display:none;">
	                <div class="ub ub-ver">
	                	<h3 class="tx-c uinn5">修改用户登录密码</h3>
	                	<div class="uinn">
							<!--文本开始-->
							<div class="ub t-bla ulab">  
								<div class="uinn ulim">原密码:</div> 
							 	<div class="ub-f1 c-wh uba b-gra us-i uinput uinn1 ub ub-ver">  
							 		<input placeholder="原密码" type="password" class="" id="oldpass">   
							  	</div>
							</div>
							<!--文本结束-->
	                	</div>
	                	<div class="uinn">
							<!--文本开始-->
							<div class="ub t-bla ulab">  
								<div class="uinn ulim">新密码:</div> 
							 	<div class="ub-f1 c-wh uba b-gra us-i uinput uinn1 ub ub-ver">  
							 		<input placeholder="新密码" type="password" class="" id="newpass1">   
							  	</div>
							</div>
							<!--文本结束-->
	                	</div>
	                	<div class="uinn">
							<!--文本开始-->
							<div class="ub t-bla ulab">  
								<div class="uinn ulim">请确认:</div> 
							 	<div class="ub-f1 c-wh uba b-gra us-i uinput uinn1 ub ub-ver">  
							 		<input placeholder="新密码" type="password" class="" id="newpass2">   
							  	</div>
							</div>
							<!--文本结束-->
	                	</div>
	                	<div class="uinn">
	                		<!--按钮开始-->
							<div ontouchstart="zy_touch('btn-act')" onclick="changePass()" class="btn uinn c-red1 c-m2 uc-a">确认修改</div>
							<!--按钮结束-->
	                	</div>
                	
                	</div>

				</div>
            </div>
            <!--content结束--><!--footer开始-->
            <div id="footer" class="uf c-m2 c-bla t-wh">
            </div>
            <!--footer结束-->
        </div>
    </body>
    <script>
    	zy_init();
		
		//要上传的文件[图片]
		var uploadImg = '';
		//获取上传头像的用户
		var stunumber = getLocVal('stunumber');
		stunumber = encodeURIComponent(stunumber);
		//上传的服务器地址
		var httpAddress = 'http://10.108.90.35:8080/zendproject/TestProject/bni/index.php?stunumber='+stunumber;
		
		window.uexOnload=function(type){
			if(!type){
				//获取用户信息
				getUserInfo();
			}
			//actionSheet回调函数
			uexWindow.cbActionSheet = function(opId,dataType,data){
				switch(parseInt(data)){
					case 0:
						uexCamera.open();
						break;
					case 1:
						uexImageBrowser.pick();
						break;
				}
			};
			//相机回调函数
			uexCamera.cbOpen = function(opId,dataType,data){
				if(dataType == 0){
					alert(data);
					uploadImg = data;
					uploadHeadImage();	
					//$$('headPic').style.cssText = "background:url('"+data+"');";
				}
			};
			//图片浏览器回调函数
			uexImageBrowser.cbPick = function(opId,dataType,data){
				
				alert(data);
				uploadImg = data;
				uploadHeadImage();	
				//$$('headPic').style.cssText = "background:url('"+data+"');";
			};
			//创建上传对象回调
			uexUploaderMgr.cbCreateUploader = function(opId,dataType,data){
				if(dataType == 2){
//					alert('cbCreateUploader:'+data);
					uexUploaderMgr.uploadFile(1,uploadImg,'filename',0);
					uexWindow.toast(1,5,"头像上传ing...",0);
//					alert('文件路径是:'+uploadImg);
				}
			};
			//上传文件回调函数
			uexUploaderMgr.onStatus = function(opId,fileSize,percent,serverPath,status){
//				alert('上传状态');
//				alert('fileSize'+fileSize);			
//				alert('serverPath'+serverPath);
//				alert('status'+status);
				switch(status){
					case 0:
						document.getElementById('percent').value = percent+"%";
						break;
					case 1:
						uexWindow.closeToast();//关闭提示消息框
						alert("上传头像成功");
						refreshImg();
						uexUploaderMgr.closeUploader(opId);
						break;
					case 2:
						alert("上传失败!");
						uexUploaderMgr.closeUploader(opId);
						break;
					default: 
						break;
				}
 			}
		}
		//打开ActionSheet更换头像
		function openActionSheet(){
			uexWindow.actionSheet('选择图片','取消',['拍照','图片']);
		}
		//上传头像
		function uploadHeadImage(){
			uexUploaderMgr.createUploader(1,httpAddress);
//			alert('createUploader成功!');
		}
		//获取用户头像的url
		var userName = getLocVal('stuname');

		var imgurl = 'http://10.108.90.35:8080/zendproject/TestProject/bni/ReturnLoginInfo.php?action=imgpath&userName=' + userName;
		
		//获得登录用户的个人信息
		function getUserInfo(){
			var userGroup = getLocVal('stugroup');
			var userGrade = getLocVal('stugrade');
			var userMotto = getLocVal('stumotto');

			setHtml('username',userName);
			setHtml('motto',userMotto);
			setHtml('grade',userGrade+' 　');
			setHtml('place','暂无地址信息');
			//获取头像
			$.getJSON(imgurl,function(data){
				window.localStorage['imgPath'] = data.imgpath;
 				document.getElementById('headpic').src = data.imgpath;
			}, 'json', getJSONError, 'post',null,true);
			
			$$('usergroup').innerHTML = '研究室:　'+userGroup;
		}
		function refreshImg(){
			$.clearLS(imgurl);
			getUserInfo();
		}
		//打开修改用户密码界面
		function displayChangePass(){
			//显示和隐藏相应的div
			var oUserInfo = document.getElementById('userinfo');
			var oUserChangePass = document.getElementById('userchangepass');
			//显示或隐藏div
			if(oUserInfo.style.display == 'block'){
				oUserInfo.style.display = 'none';
			}else{
				oUserInfo.style.display = 'block';
			}
			if(oUserChangePass.style.display == 'block'){
				oUserChangePass.style.display = 'none';
			}else{
				oUserChangePass.style.display = 'block';
			}
		}
		//修改密码
		function changePass(){
			//设置输入焦点
			document.getElementById('oldpass').focus();
			//获得输入的修改密码信息
			var oldPass = $$('oldpass').value;
			var newPass1 = $$('newpass1').value;
			var newPass2 = $$('newpass2').value;
			var flag = true;
			//检查输入密码合法性
			if(!oldPass){
				alert('请输入旧密码');
				//oldPass.focus();
				flag = false;
				document.getElementById('oldpass').focus();
			}
			else if(!newPass1 || !newPass2){
				alert('请输入新密码');
				flag = false;
				//newPass1.focus();
				document.getElementById('newpass1').focus();
			}
			else if(newPass1 != newPass2){
				alert('输入的密码不一致');
				flag = false;
				//newPass1.focus();
				document.getElementById('newpass1').focus();
			}
			if(flag == true){
				//获得修改密码的用户名
				var userName = window.localStorage['stuname'];
				var stuName = encodeURIComponent(userName);
				var stuPass = encodeURIComponent(newPass1);
				//修改密码url
				var url = 'http://10.108.90.35:8080/zendproject/TestProject/bni/ReturnPassword.php?userName='+stuName+'&newPass='+stuPass;
				$toast('修改密码中...');
				$.getJSON(url,function(data){
					$closeToast();
					if(data.changeUserPass == '修改密码成功'){
						alert('密码修改成功!');
						displayChangePass();
					}
				},'json',null,'GET',null,false);
			}
		}
    </script>
</html>
